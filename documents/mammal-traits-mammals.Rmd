---
title: "Relationships between population change (lambdas) and traits for Mammals"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    theme: paper
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

library(here)
library(dplyr)
library(lme4)
library(performance)
library(sjPlot)
library(ggplot2)
library(visdat)
library(patchwork)

# set a ggplot theme for all plots
theme_set(ggpubr::theme_pubr())

model_data = read.csv(here("scripts/CIEE_model_data.csv"), as.is = T)
model_data = model_data %>%
  filter(Replicate == 0)

trait_data = data.table::fread(here("data-clean/traits-all.csv"))

# join the datasets
df_join = left_join(model_data, trait_data, by = "Binomial")
# convert trophic level to factor
df_join$TrophicLevel <- factor(df_join$TrophicLevel)
```


## Mammals in Canada

These are models to evaluate the relationship between average population change and body size, trophic level, and lifespan traits, while accounting for differences in System, and including a random effect by Binomial because the trait data was collected at the species level. The Class variable is not included in these models, because the data is subset within the Mammals class.

```{r}
df_taxon = filter(df_join, Class == "Mammals") %>% na.omit()
```


```{r}
# null model
m0 = lmer(avlambda ~ (1|Binomial), data = df_taxon)
m1 = lmer(avlambda ~ System + (1|Binomial), data = df_taxon)

# adding traits

# body size only
# class should be in each model because body size is normalised within classes
m2 = lmer(avlambda ~ log10(BodySize) + (1|Binomial),  data = df_taxon)
m3 = lmer(avlambda ~ log10(BodySize) + System + (1|Binomial),  data = df_taxon)
m4 = lmer(avlambda ~ System*log10(BodySize) + (1|Binomial),  data = df_taxon)

# trophic level only
m5 = lmer(avlambda ~ TrophicLevel + (1|Binomial),  data = df_taxon)
m6 = lmer(avlambda ~ TrophicLevel + System + (1|Binomial),  data = df_taxon)
m7 = lmer(avlambda ~ System*TrophicLevel + (1|Binomial),  data = df_taxon)

# lifespan only
m8 = lmer(avlambda ~ LifeSpan + (1|Binomial),  data = df_taxon)
m9 = lmer(avlambda ~ LifeSpan + System + (1|Binomial),  data = df_taxon)
m10 = lmer(avlambda ~ System*LifeSpan + (1|Binomial),  data = df_taxon)

# all three traits
m11 = lmer(avlambda ~ log10(BodySize) + TrophicLevel + (1|Binomial),  data = df_taxon)
m12 = lmer(avlambda ~ log10(BodySize) + LifeSpan + (1|Binomial),  data = df_taxon)
m13 = lmer(avlambda ~ TrophicLevel + LifeSpan + (1|Binomial),  data = df_taxon)
m14 = lmer(avlambda ~ log10(BodySize) + TrophicLevel + LifeSpan + (1|Binomial),  data = df_taxon)
```

-------

### Model comparison

```{r}
compare_performance(m0, m1, # no traits
                    m2, m3, m4, # body size
                    m5, m6, m7, # trophic
                    m8, m9, m10, # lifespan
                    m11, m12, m13, m14, # combos of traits
                    rank = TRUE) %>% head() %>%
  kableExtra::kable() %>% kableExtra::kable_styling("striped")
```

-------

### "Best" model(s) evaluation

#### Model 5:  `avlambda ~ TrophicLevel + (1|Binomial)`

```{r, fig.height=9}
check_model(m5)
```

```{r, results='hide', fig.show='hold', out.width='50%'}
plot_model(m5, type="pred")
```

```{r, fig.height = 9, results='hide', fig.show='hold', out.width='50%'}
plot_model(m5, type="re")
```


#### Model 13: `avlambda ~ TrophicLevel + LifeSpan + (1|Binomial)`

```{r, fig.height=9}
#check_model(m13)
```

```{r, results='hide', fig.show='hold', out.width='50%'}
plot_model(m13, type="pred")
```

```{r, fig.height = 9, results='hide', fig.show='hold', out.width='50%'}
plot_model(m13, type="re")
```


----- 

# Summed lambdas

## Mammals in Canada

These are models to evaluate the relationship between summed population change and body size, trophic level, and lifespan traits, while accounting for differences in System and Class, and including a random effect by Binomial because the trait data was collected at the species level. Each model includes time series length to account for differences in summed lambdas in shorter vs. longer time series.

```{r}
# null model
m0 = lmer(sumlambda ~ (1|Binomial), data = df_taxon)
m1 = lmer(sumlambda ~ System + (1|Binomial), data = df_taxon)

# adding traits

# body size only
# class should be in each model because body size is normalised within classes
m2 = lmer(sumlambda ~ log10(BodySize) + (1|Binomial) + tslength,  data = df_taxon)
m3 = lmer(sumlambda ~ log10(BodySize) + System + (1|Binomial) + tslength,  data = df_taxon)
m4 = lmer(sumlambda ~ System*log10(BodySize) + (1|Binomial) + tslength,  data = df_taxon)

# trophic level only
m5 = lmer(sumlambda ~ TrophicLevel + (1|Binomial) + tslength,  data = df_taxon)
m6 = lmer(sumlambda ~ TrophicLevel + System + (1|Binomial) + tslength,  data = df_taxon)
m7 = lmer(sumlambda ~ System*TrophicLevel + (1|Binomial) + tslength,  data = df_taxon)

# lifespan only
m8 = lmer(sumlambda ~ LifeSpan + (1|Binomial) + tslength,  data = df_taxon)
m9 = lmer(sumlambda ~ LifeSpan + System + (1|Binomial) + tslength,  data = df_taxon)
m10 = lmer(sumlambda ~ System*LifeSpan + (1|Binomial) + tslength,  data = df_taxon)

# all three traits
m11 = lmer(sumlambda ~ log10(BodySize) + TrophicLevel + (1|Binomial) + tslength,  data = df_taxon)
m12 = lmer(sumlambda ~ log10(BodySize) + LifeSpan + (1|Binomial) + tslength,  data = df_taxon)
m13 = lmer(sumlambda ~ TrophicLevel + LifeSpan + (1|Binomial) + tslength,  data = df_taxon)
m14 = lmer(sumlambda ~ log10(BodySize) + TrophicLevel + LifeSpan + (1|Binomial) + tslength,  data = df_taxon)
```

-------

### Model comparison

```{r}
compare_performance(m0, m1, # no traits
                    m2, m3, m4, # body size
                    m5, m6, m7, # trophic
                    m8, m9, m10, # lifespan
                    m11, m12, m13, m14, # combos of traits
                    rank = TRUE) %>% head() %>%
  kableExtra::kable() %>% kableExtra::kable_styling("striped")
```

---------

### "Best" model(s) evaluation

#### Model 5: `sumlambda ~ TrophicLevel + (1|Binomial) + tslength`

```{r, fig.height=9}
#check_model(m5)
```

```{r, fig.show='hold', out.width='50%', results='hide'}
plot_model(m5, type="pred")
```
