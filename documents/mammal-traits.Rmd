---
title: 'Mammal trait summary'
output:
  html_document:
    theme: paper
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = F, message = F)

# load packages
library(here)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(patchwork)

# set ggplot themes
theme_set(theme_pubclean())
```

```{r}
df <- readRDS(here("data-clean/LPI_pantheria.rds")) %>%
  filter(Class %in% c("Mammalia", "Mammals")) %>%
  # keep unique binomials only, to avoid having duplicates that falsely inflate
  # the number of observations per trait value
  distinct(Binomial, .keep_all = TRUE)
```

We extracted three traits for mammals in the Canadian LPI dataset from Pantheria (see `extract_pantheria.R`):
- Body mass (g)
- Trophic Level (1, 2, 3)
- Maximum Longevity

### Distribution of the traits

```{r,fig.show='hold', message=FALSE, warning = FALSE, fig.height = 4, fig.width=9}
A <- ggplot(df) +
  geom_histogram(aes(x = log(AdultBodyMass_g)),
                 binwidth = 2, col = "white",
                 fill = "navyblue", alpha = .6) +
  labs(x = "log Body Mass (g)")
B <- ggplot(df) +
  geom_histogram(aes(x = TrophicLevel),
                 binwidth = 1, col = "white",
                 fill = "firebrick", alpha = .6) +
  labs(x = "Trophic Level")
C <- ggplot(df) +
  geom_histogram(aes(x = MaxLongevity_m),
                 bins = 15, col = "white",
                 fill = "darkgreen", alpha = .6) +
  labs(x = "Max Longevity")
A + B + C
```

```{r,fig.show='hold', message=FALSE, warning = FALSE, fig.height = 4, fig.width=9, include = FALSE}
A <- ggplot(df) +
  geom_density(aes(x = log(AdultBodyMass_g)),
               col = "white",
               fill = "navyblue", alpha = .6) +
  labs(x = "log Body Mass (g)")
B <- ggplot(df) +
  geom_histogram(aes(x = TrophicLevel),
                 binwidth = 1, col = "white",
                 fill = "firebrick", alpha = .6) +
  labs(x = "Trophic Level")
C <- ggplot(df) +
  geom_density(aes(x = MaxLongevity_m),
               col = "white",
               fill = "darkgreen", alpha = .6) +
  labs(x = "Max Longevity")
A + B + C
```


### Traits ~ rate of change

Do the traits seem to be related to average rate of change for Canadian LPI species?

```{r, warning = F}
lpi <- readRDS("~/Documents/GitHub/LPD/example_code/data/CIEE_LPI_combined.rds")

df_plot <- full_join(lpi, df, by = "Binomial") %>%
  filter(Class.x %in% c("Mammalia", "Mammals"))

A <- ggplot(df_plot,
            aes(x = log(AdultBodyMass_g), y = avlambda) ) +
  geom_point(alpha = .1) +
  geom_smooth(method = "lm", col = "firebrick") +
  labs(x = "log Body Mass (g)")

B <- ggplot(df_plot, aes(x = as.factor(TrophicLevel), y = avlambda,
                         fill = as.factor(TrophicLevel)) ) +
  geom_boxplot() +
  labs(x = "Trophic Level")

C <- ggplot(df_plot, aes(x = MaxLongevity_m, y = avlambda) ) +
  geom_point(alpha = .1) +
  geom_smooth(method = "lm", col = "firebrick") +
  labs(x = "Max Longevity")

A + B + C
```


### Comparing trait distributions

These are the distributions of each trait for mammals in the Canadian LPI dataset (**C-LPI**), compared with the distribution of these traits for all Canadian mammals in the **Wild Species List**, and with all mammals in the full trait dataset (**Pantheria**).

```{r}
# load packages
library(traitdata)
library(dplyr)

# load pantheria dataset
data("pantheria")
# code trophic level as a factor
pantheria$TrophicLevel <- factor(pantheria$TrophicLevel)
```


```{r}
# make palette
colors <- c("All Mammals" = "slategray",
            "Canadian Wild Species" = "navyblue",
            "C-LPI" = "firebrick")

# read wild species report data
wildsp <- readr::read_csv("~/Documents/GitHub/LPD/trait_data_hunting/data-raw/WildSpecies2015Data.csv")

# subset to mammals
wildmammals <- wildsp[grep("Mammals", wildsp$`TAXONOMIC GROUP - GROUPE TAXONOMIQUE`),]

# subset to canada
pantheria_canada <- 
  filter(pantheria, scientificNameStd %in% wildmammals$`SCIENTIFIC NAME - NOM SCIENTIFIQUE`)
```



```{r}
data.frame(
  "Scale" = c("Global", "Canada", "Canada (LPI)"),
  "Species list" = c("Pantheria", "Wild Species Report", "Canadian-LPI"),
  "Number of mammal species" = c(nrow(pantheria), 
                                 nrow(wildmammals), 
                                 nrow(pantheria_canada))
  ) %>% 
  kableExtra::kable(col.names = c("Scale", "Species list source", "Number of Mammal Species")) %>%
  kableExtra::kable_styling(bootstrap_options = "striped")
```


```{r}
ggplot() +
  geom_density(data = pantheria,
               aes(x = log(AdultBodyMass_g), fill = "All Mammals"),
               lwd = 0.2, alpha = .5) +
  geom_density(data = pantheria_canada,
               aes(x = log(AdultBodyMass_g), fill = "Canadian Wild Species"),
               lwd = 0.2, alpha = .5) +
  geom_density(data = df,
               aes(x = log(AdultBodyMass_g), fill = "C-LPI"),
               lwd = 0.2, alpha = .5) +
  scale_fill_manual(values = colors) +
  labs(title = "Body size", x = "log Body mass (g)", y = "Density",
       fill = "Dataset")
```

```{r}
A <- ggplot() +
  geom_histogram(data = filter(pantheria, !is.na(TrophicLevel)),
                 aes(x = TrophicLevel, fill = "All Mammals"),
                 lwd = .2, alpha = .3, binwidth = .5,
                 stat = "count") +
  geom_histogram(data = pantheria_canada,
                 aes(x = TrophicLevel, fill = "Canadian Wild Species"),
                 lwd = .2, alpha = .7, binwidth = .5,
                 stat = "count") +
  geom_histogram(data = df,
                 aes(x = factor(TrophicLevel), fill = "C-LPI"),
                 lwd = .2, alpha = .8, binwidth = .5,
                 stat = "count") +
  scale_fill_manual(values = colors) +
  labs(title = "Trophic Level", x = "Trophic Level", fill = "Dataset")
# same plot, but without the whole pantheria dataset, to zoom into the differenc between Canadian Wild Species and the LPI-C
B <- ggplot() +
  geom_histogram(data = pantheria_canada,
                 aes(x = TrophicLevel, fill = "Canadian Wild Species"),
                 lwd = .2, alpha = .7, binwidth = .5,
                 stat = "count") +
  geom_histogram(data = df,
                 aes(x = factor(TrophicLevel), fill = "C-LPI"),
                 lwd = .2, alpha = .7, binwidth = .5,
                 stat = "count") +
  scale_fill_manual(values = colors) +
  labs(title = "Trophic Level (Canada only)", x = "Trophic Level", fill = "Dataset")
A + B
```

```{r}
ggplot() +
  geom_density(data = pantheria,
               aes(x = MaxLongevity_m, fill = "All Mammals"),
               lwd = 0.2, alpha = .5) +
  geom_density(data = pantheria_canada,
               aes(x = MaxLongevity_m, fill = "Canadian Wild Species"),
               lwd = 0.2, alpha = .5) +
  geom_density(data = df,
               aes(x = MaxLongevity_m, fill = "C-LPI"),
               lwd = 0.2, alpha = .5) +
  scale_fill_manual(values = colors) +
  labs(title = "Maximum longevity", x = "Maximum longevity", y = "Density",
       fill = "Dataset")
```
