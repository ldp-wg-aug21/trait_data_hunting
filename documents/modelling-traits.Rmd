---
title: "Relationships between population change (lambdas) and traits"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    theme: paper
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

library(here)
library(dplyr)
library(lme4)
library(performance)
library(sjPlot)
library(ggplot2)

# set a ggplot theme for all plots
theme_set(theme_classic())

model_data = read.csv(here("scripts/CIEE_model_data.csv"), as.is = T)
model_data = model_data %>%
  filter(Replicate == 0)

trait_data = data.table::fread(here("data-clean/traits-all.csv"))

df = left_join(model_data, trait_data, by = "Binomial")

# convert trophic level to factor
df$TrophicLevel <- factor(df$TrophicLevel)
```

# Modelling change as average lambdas

## All taxa in Canada

These are models to evaluate the relationship between average population change and body size, trophic level, and lifespan traits, while accounting for differences in System and Class, and including a random effect by Binomial because the trait data was collected at the species level.

```{r}
# null model
m0 = lmer(avlambda ~ (1|Binomial), data = df)
m1 = lmer(avlambda ~ Class + (1|Binomial),  data = df)
m2 = lmer(avlambda ~ Class + System + (1|Binomial), data = df)
m3 = lmer(avlambda ~ System + (1|Binomial), data = df)

# adding traits

# body size only
# class should be in each model because body size is normalised within classes
m4 = lmer(avlambda ~ log10(BodySize) + Class + (1|Binomial),  data = df)
m5 = lmer(avlambda ~ log10(BodySize) + Class + System + (1|Binomial),  data = df)
m6 = lmer(avlambda ~ Class*log10(BodySize) + (1|Binomial),  data = df)
m7 = lmer(avlambda ~ System*log10(BodySize) + (1|Binomial),  data = df)

# trophic level only
m8 = lmer(avlambda ~ TrophicLevel + (1|Binomial),  data = df)
m9 = lmer(avlambda ~ TrophicLevel + Class + (1|Binomial),  data = df)
m10 = lmer(avlambda ~ TrophicLevel + System + (1|Binomial),  data = df)
m11 = lmer(avlambda ~ Class*TrophicLevel + (1|Binomial),  data = df)
m12 = lmer(avlambda ~ System*TrophicLevel + (1|Binomial),  data = df)

# lifespan only
m13 = lmer(avlambda ~ LifeSpan + (1|Binomial),  data = df)
m14 = lmer(avlambda ~ LifeSpan + Class + (1|Binomial),  data = df)
m15 = lmer(avlambda ~ LifeSpan + System + (1|Binomial),  data = df)
m16 = lmer(avlambda ~ Class*LifeSpan + (1|Binomial),  data = df)
m17 = lmer(avlambda ~ System*LifeSpan + (1|Binomial),  data = df)

# all three traits
m18 = lmer(avlambda ~ log10(BodySize) + TrophicLevel + Class + (1|Binomial),  data = df)
m19 = lmer(avlambda ~ log10(BodySize) + LifeSpan + Class + (1|Binomial),  data = df)
m20 = lmer(avlambda ~ TrophicLevel + LifeSpan + (1|Binomial),  data = df)
m21 = lmer(avlambda ~ log10(BodySize) + TrophicLevel + LifeSpan + Class + (1|Binomial),  data = df)
```

-----

### Model comparison

If we compare these models, their performance looks like...

```{r}
compare_performance(m0, m1, m2, m3, # no traits
                    m4, m5, m6, m7, # body size
                    m8, m9, m10, m11, m12, # trophic level
                    m13, m14, m15, m16, m17, # lifespan
                    m18, m19, m20, m21, # variations of 2 or 3 traits
                    rank = TRUE) %>%
  kableExtra::kable() %>% kableExtra::kable_styling("striped")
```

-----

### "Best" model(s) evaluation

Let's look at the top models!

#### Model 12 : `avlambda ~ System*TrophicLevel + (1|Binomial)`

```{r, fig.height=9}
check_model(m12)
```

```{r, results='hide', fig.show='hold', out.width='50%'}
plot_model(m12, type="pred")
```

#### Model 17: `avlambda ~ System*LifeSpan + (1|Binomial)`

```{r, fig.height=9}
check_model(m17)
```

```{r, results='hide', fig.show='hold', out.width='50%'}
plot_model(m17, type="pred")
```

-----

## Mammals in Canada

These are models to evaluate the relationship between average population change and body size, trophic level, and lifespan traits, while accounting for differences in System, and including a random effect by Binomial because the trait data was collected at the species level. The Class variable is not included in these models, because the data is subset within the Mammals class.


```{r}
df_taxon = filter(df, Class == "Mammals")

# null model
m0 = lmer(avlambda ~ (1|Binomial), data = df_taxon)
m1 = lmer(avlambda ~ System + (1|Binomial), data = df_taxon)

# adding traits

# body size only
# class should be in each model because body size is normalised within classes
m2 = lmer(avlambda ~ log10(BodySize) + (1|Binomial),  data = df_taxon)
m3 = lmer(avlambda ~ log10(BodySize) + System + (1|Binomial),  data = df_taxon)
m4 = lmer(avlambda ~ System*log10(BodySize) + (1|Binomial),  data = df_taxon)

# trophic level only
m5 = lmer(avlambda ~ TrophicLevel + (1|Binomial),  data = df_taxon)
m6 = lmer(avlambda ~ TrophicLevel + System + (1|Binomial),  data = df_taxon)
m7 = lmer(avlambda ~ System*TrophicLevel + (1|Binomial),  data = df_taxon)

# lifespan only
m8 = lmer(avlambda ~ LifeSpan + (1|Binomial),  data = df_taxon)
m9 = lmer(avlambda ~ LifeSpan + System + (1|Binomial),  data = df_taxon)
m10 = lmer(avlambda ~ System*LifeSpan + (1|Binomial),  data = df_taxon)

# all three traits
m11 = lmer(avlambda ~ log10(BodySize) + TrophicLevel + (1|Binomial),  data = df_taxon)
m12 = lmer(avlambda ~ log10(BodySize) + LifeSpan + (1|Binomial),  data = df_taxon)
m13 = lmer(avlambda ~ TrophicLevel + LifeSpan + (1|Binomial),  data = df_taxon)
m14 = lmer(avlambda ~ log10(BodySize) + TrophicLevel + LifeSpan + (1|Binomial),  data = df_taxon)
```

-------

### Model comparison

```{r}
compare_performance(m0, m1, # no traits
                    m2, m3, m4, # body size
                    m5, m6, m7, # trophic
                    m8, m9, m10, # lifespan
                    m11, m12, m13, m14, # combos of traits
                    rank = TRUE) %>%
  kableExtra::kable() %>% kableExtra::kable_styling("striped")
```

-------

### "Best" model(s) evaluation

The two best models are two of the null options (m0 and m1). However, let's take a look at the best model with traits included:

#### Model 5:  `avlambda ~ TrophicLevel + (1|Binomial)`

```{r, fig.height=9}
check_model(m5)
```

```{r, results='hide', fig.show='hold', out.width='50%'}
plot_model(m5, type="pred")
```

```{r, fig.height = 9, results='hide', fig.show='hold', out.width='50%'}
plot_model(m5, type="re")
```

### Birds in Canada

```{r}
bird_df = filter(df, Class == "Birds")

# null model
m0_b = lmer(avlambda ~ (1|Binomial), data = bird_df)
m1_b = lmer(avlambda ~ System + (1|Binomial), data = bird_df)

# adding traits

# body size only
# class should be in each model because body size is normalised within classes
m2_b = lmer(avlambda ~ log10(BodySize) + (1|Binomial),  data = bird_df)
m3_b = lmer(avlambda ~ log10(BodySize) + System + (1|Binomial),  data = bird_df)
m4_b = lmer(avlambda ~ System*log10(BodySize) + (1|Binomial),  data = bird_df)

# trophic level only
m5_b = lmer(avlambda ~ TrophicLevel + (1|Binomial),  data = bird_df)
m6_b = lmer(avlambda ~ TrophicLevel + System + (1|Binomial),  data = bird_df)
m7_b = lmer(avlambda ~ System*TrophicLevel + (1|Binomial),  data = bird_df)

# lifespan only
m8_b = lmer(avlambda ~ LifeSpan + (1|Binomial),  data = bird_df)
m9_b = lmer(avlambda ~ LifeSpan + System + (1|Binomial),  data = bird_df)
m10_b = lmer(avlambda ~ System*LifeSpan + (1|Binomial),  data = bird_df)

# all three traits
m11_b = lmer(avlambda ~ log10(BodySize) + TrophicLevel + (1|Binomial),  data = df)
m12_b = lmer(avlambda ~ log10(BodySize) + LifeSpan + (1|Binomial),  data = df)
m13_b = lmer(avlambda ~ TrophicLevel + LifeSpan + (1|Binomial),  data = df)
m14_b = lmer(avlambda ~ log10(BodySize) + TrophicLevel + LifeSpan + (1|Binomial),  data = df)
```


------

# Modelling change as summed lambdas

## All taxa in Canada

These are models to evaluate the relationship between summed population change and body size, trophic level, and lifespan traits, while accounting for differences in System and Class, and including a random effect by Binomial because the trait data was collected at the species level.

```{r}
# null model
m0 = lmer(sumlambda ~ (1|Binomial), data = df)
m1 = lmer(sumlambda ~ Class + (1|Binomial),  data = df)
m2 = lmer(sumlambda ~ Class + System + (1|Binomial), data = df)
m3 = lmer(sumlambda ~ System + (1|Binomial), data = df)

# adding traits

# body size only
# class should be in each model because body size is normalised within classes
m4 = lmer(sumlambda ~ log10(BodySize) + Class + (1|Binomial),  data = df)
m5 = lmer(sumlambda ~ log10(BodySize) + Class + System + (1|Binomial),  data = df)
m6 = lmer(sumlambda ~ Class*log10(BodySize) + (1|Binomial),  data = df)
m7 = lmer(sumlambda ~ System*log10(BodySize) + (1|Binomial),  data = df)

# trophic level only
m8 = lmer(sumlambda ~ TrophicLevel + (1|Binomial),  data = df)
m9 = lmer(sumlambda ~ TrophicLevel + Class + (1|Binomial),  data = df)
m10 = lmer(sumlambda ~ TrophicLevel + System + (1|Binomial),  data = df)
m11 = lmer(sumlambda ~ Class*TrophicLevel + (1|Binomial),  data = df)
m12 = lmer(sumlambda ~ System*TrophicLevel + (1|Binomial),  data = df)

# lifespan only
m13 = lmer(sumlambda ~ LifeSpan + (1|Binomial),  data = df)
m14 = lmer(sumlambda ~ LifeSpan + Class + (1|Binomial),  data = df)
m15 = lmer(sumlambda ~ LifeSpan + System + (1|Binomial),  data = df)
m16 = lmer(sumlambda ~ Class*LifeSpan + (1|Binomial),  data = df)
m17 = lmer(sumlambda ~ System*LifeSpan + (1|Binomial),  data = df)

# all three traits
m18 = lmer(sumlambda ~ log10(BodySize) + TrophicLevel + Class + (1|Binomial),  data = df)
m19 = lmer(sumlambda ~ log10(BodySize) + LifeSpan + Class + (1|Binomial),  data = df)
m20 = lmer(sumlambda ~ TrophicLevel + LifeSpan + (1|Binomial),  data = df)
m21 = lmer(sumlambda ~ log10(BodySize) + TrophicLevel + LifeSpan + Class + (1|Binomial),  data = df)
```

-------

### Model comparison

```{r}
compare_performance(m0, m1, m2, m3, # no traits
                    m4, m5, m6, m7, # body size
                    m8, m9, m10, m11, m12, # trophic level
                    m13, m14, m15, m16, m17, # lifespan
                    m18, m19, m20, m21, # variations of 2 or 3 traits
                    rank = TRUE) %>%
  kableExtra::kable() %>% kableExtra::kable_styling("striped")
```

---------

### "Best" model(s) evaluation

#### Model 16: `sumlambda ~ Class*LifeSpan + (1|Binomial)`

```{r, fig.height=9}
check_model(m16)
```

```{r, fig.show='hold', out.width='50%', results='hide'}
plot_model(m16, type="pred")
```

#### Model 17: `sumlambda ~ System*LifeSpan + (1|Binomial)`

```{r, fig.height=9}
check_model(m17)
```

```{r, fig.show='hold', out.width='50%', results='hide'}
plot_model(m17, type="pred")
```
